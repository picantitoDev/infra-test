---
- name: üß© Configurar NFS Client + Docker + Promtail
  hosts: promtail
  become: yes

  vars:
    # Rutas y endpoints
    promtail_dir: /root/promtail
    loki_url: "http://10.10.0.2:3100/loki/api/v1/push"

    # Exports NFS de productores (proxy/app/db)
    proxy_nfs: "10.10.0.1:/var/lib/docker/containers"
    app_nfs:   "10.20.0.1:/var/lib/docker/containers"
    db_nfs:    "10.30.0.1:/var/lib/docker/containers"

    # Puntos de montaje locales
    proxy_mount: /mnt/proxy-logs/docker
    app_mount:   /mnt/app-logs/docker
    db_mount:    /mnt/db-logs/docker

  tasks:
    # ----------------------------
    # 0) Paquetes base + NFS client
    # ----------------------------
    - name: Actualizar cache APT e instalar nfs-common y utilidades base
      apt:
        update_cache: yes
        cache_valid_time: 3600
        name:
          - nfs-common
          - ca-certificates
          - curl
        state: present

    # ----------------------------
    # 1) Instalar Docker (repo oficial)
    # ----------------------------
    - name: Crear directorio para clave GPG de Docker
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Descargar clave GPG de Docker
      get_url:
        url: https://download.docker.com/linux/debian/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: "0644"

    - name: Obtener arquitectura del sistema
      command: dpkg --print-architecture
      register: system_arch
      changed_when: false

    - name: Obtener codename de Debian
      shell: . /etc/os-release && echo "$VERSION_CODENAME"
      register: debian_codename
      changed_when: false

    - name: Agregar repositorio oficial de Docker
      apt_repository:
        repo: "deb [arch={{ system_arch.stdout }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian {{ debian_codename.stdout }} stable"
        filename: docker
        state: present

    - name: Actualizar cache tras agregar repo Docker
      apt:
        update_cache: yes

    - name: Instalar Docker Engine y complementos
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    - name: Asegurar que Docker est√© activo
      systemd:
        name: docker
        state: started
        enabled: yes

    # ----------------------------
    # 2) Crear directorios de montura
    # ----------------------------
    - name: Crear directorios de montura
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ proxy_mount }}"
        - "{{ app_mount }}"
        - "{{ db_mount }}"

    # ----------------------------
    # 3) Montar NFS (y persistir en /etc/fstab)
    # ----------------------------
    - name: Montar NFS del proxy (y persistir)
      mount:
        src: "{{ proxy_nfs }}"
        path: "{{ proxy_mount }}"
        fstype: nfs
        opts: defaults
        state: mounted

    - name: Montar NFS de la app (y persistir)
      mount:
        src: "{{ app_nfs }}"
        path: "{{ app_mount }}"
        fstype: nfs
        opts: defaults
        state: mounted

    - name: Montar NFS de la base de datos (y persistir)
      mount:
        src: "{{ db_nfs }}"
        path: "{{ db_mount }}"
        fstype: nfs
        opts: defaults
        state: mounted

    # ----------------------------
    # 4) Estructura Promtail + config
    # ----------------------------
    - name: Crear estructura de Promtail
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - "{{ promtail_dir }}"
        - "{{ promtail_dir }}/positions"

    - name: Crear archivo de configuraci√≥n de Promtail
      copy:
        dest: "{{ promtail_dir }}/promtail-config.yaml"
        mode: "0644"
        content: |
          server:
            http_listen_port: 9080
            grpc_listen_port: 0

          positions:
            filename: /tmp/positions.yaml

          clients:
            - url: {{ loki_url }}

          scrape_configs:
            - job_name: proxy_docker
              static_configs:
                - targets: ['localhost']
                  labels:
                    job: proxy_docker
                    __path__: {{ proxy_mount }}/*/*-json.log

            - job_name: app_docker
              static_configs:
                - targets: ['localhost']
                  labels:
                    job: app_docker
                    __path__: {{ app_mount }}/*/*-json.log

            - job_name: db_docker
              static_configs:
                - targets: ['localhost']
                  labels:
                    job: db_docker
                    __path__: {{ db_mount }}/*/*-json.log

    - name: Crear docker-compose.yml para Promtail
      copy:
        dest: "{{ promtail_dir }}/docker-compose.yml"
        mode: "0644"
        content: |
          name: promtail
          services:
            promtail:
              image: grafana/promtail:3.3.2
              container_name: promtail
              restart: unless-stopped
              command: -config.file=/etc/promtail/config.yaml
              privileged: true
              network_mode: host
              volumes:
                - {{ promtail_dir }}/promtail-config.yaml:/etc/promtail/config.yaml:ro
                - {{ promtail_dir }}/positions:/tmp
                - {{ proxy_mount }}:{{ proxy_mount }}:ro
                - {{ app_mount }}:{{ app_mount }}:ro
                - {{ db_mount }}:{{ db_mount }}:ro
    # ----------------------------
    # 5) Desplegar Promtail
    # ----------------------------
    - name: Desplegar Promtail con Docker Compose
      shell: |
        cd {{ promtail_dir }}
        docker compose up -d
      args:
        executable: /bin/bash

    # ----------------------------
    # 6) Verificaci√≥n
    # ----------------------------
    - name: Verificar contenedor Promtail
      shell: docker ps --filter "name=promtail" --format 'table {{ "{{.Names}}\t{{.Status}}\t{{.Ports}}" }}'
      register: promtail_status
      changed_when: false

    - debug:
        msg: "{{ promtail_status.stdout_lines }}"
