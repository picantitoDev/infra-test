---
- name: ğŸ‡ Configurar servidor RabbitMQ con Docker
  hosts: rabbit
  become: yes
  vars:
    docker_user: "picantito"
    docker_pat: ${DOCKER_TOKEN}   # opcional si luego usas imÃ¡genes privadas
    image_name: "rabbitmq:3-management"
    container_name: "rabbitmq_sgi"
    rabbitmq_user: "sgi_user"
    rabbitmq_pass: "sgi_pass"
    amqp_port: 5672
    http_port: 15672

  tasks:
    # ----------------------------
    # ğŸ§± INSTALACIÃ“N DE DOCKER
    # ----------------------------
    - name: ğŸŒ€ Actualizar cachÃ© de APT
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: ğŸ“¦ Instalar dependencias requeridas
      apt:
        name:
          - ca-certificates
          - curl
        state: present

    - name: ğŸ“‚ Crear directorio para la clave GPG de Docker
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: ğŸ”‘ Descargar clave GPG de Docker
      get_url:
        url: https://download.docker.com/linux/debian/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: "0644"

    - name: ğŸ–¥ï¸ Obtener arquitectura del sistema
      command: dpkg --print-architecture
      register: system_arch
      changed_when: false

    - name: ğŸ§© Obtener codename de Debian
      shell: . /etc/os-release && echo "$VERSION_CODENAME"
      register: debian_codename
      changed_when: false

    - name: â• Agregar repositorio oficial de Docker
      apt_repository:
        repo: "deb [arch={{ system_arch.stdout }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian {{ debian_codename.stdout }} stable"
        filename: docker
        state: present

    - name: ğŸ”„ Actualizar cachÃ© de APT tras agregar repositorio Docker
      apt:
        update_cache: yes

    - name: ğŸ³ Instalar Docker Engine y complementos
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    - name: â–¶ï¸ Asegurar que Docker estÃ© iniciado y habilitado
      systemd:
        name: docker
        state: started
        enabled: yes

    # ----------------------------
    # ğŸš€ DEPLOY DE RABBITMQ
    # ----------------------------
    - name: ğŸ§° Eliminar contenedor anterior si existe
      community.docker.docker_container:
        name: "{{ container_name }}"
        state: absent
        force_kill: true
        purge_networks: true
      ignore_errors: true

    - name: ğŸš€ Ejecutar contenedor RabbitMQ
      community.docker.docker_container:
        name: "{{ container_name }}"
        image: "{{ image_name }}"
        restart_policy: unless-stopped
        network_mode: host     # evita conflictos en LXC
        env:
          RABBITMQ_DEFAULT_USER: "{{ rabbitmq_user }}"
          RABBITMQ_DEFAULT_PASS: "{{ rabbitmq_pass }}"
        published_ports:
          - "{{ amqp_port }}:5672"
          - "{{ http_port }}:15672"

    # ----------------------------
    # âœ… VERIFICACIÃ“N FINAL
    # ----------------------------
    - name: ğŸ” Mostrar estado del contenedor RabbitMQ
      shell: >
        docker ps --filter "name={{ container_name }}" \
        --format 'table {{ "{{.Names}}\t{{.Status}}\t{{.Ports}}" }}'
      register: rabbitmq_status
      changed_when: false

    - debug:
        msg: "{{ rabbitmq_status.stdout_lines }}"
