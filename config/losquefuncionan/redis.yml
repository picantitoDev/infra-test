---
- name: ğŸš€ Configurar servidor Redis con Docker
  hosts: redis
  become: yes
  vars:
    docker_user: "picantito"
    docker_pat: "{{ lookup('env', 'DOCKER_PAT') }}"
    image_name: "picantito/infraestructure-as-code:redis-1.0.0"
    container_name: "myredis"
    redis_password: "infra"
    redis_port: 6379

  tasks:
    # ----------------------------
    # ğŸ§± INSTALACIÃ“N DE DOCKER
    # ----------------------------
    - name: ğŸŒ€ Actualizar cachÃ© de APT
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: ğŸ“¦ Instalar dependencias requeridas
      apt:
        name:
          - ca-certificates
          - curl
        state: present

    - name: ğŸ“‚ Crear directorio para la clave GPG de Docker
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: ğŸ”‘ Descargar clave GPG de Docker
      get_url:
        url: https://download.docker.com/linux/debian/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: "0644"

    - name: ğŸ–¥ï¸ Obtener arquitectura del sistema
      command: dpkg --print-architecture
      register: system_arch
      changed_when: false

    - name: ğŸ§© Obtener codename de Debian
      shell: . /etc/os-release && echo "$VERSION_CODENAME"
      register: debian_codename
      changed_when: false

    - name: â• Agregar repositorio oficial de Docker
      apt_repository:
        repo: "deb [arch={{ system_arch.stdout }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian {{ debian_codename.stdout }} stable"
        filename: docker
        state: present

    - name: ğŸ”„ Actualizar cachÃ© de APT tras agregar repositorio Docker
      apt:
        update_cache: yes

    - name: ğŸ³ Instalar Docker Engine y complementos
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    - name: â–¶ï¸ Asegurar que Docker estÃ© iniciado y habilitado
      systemd:
        name: docker
        state: started
        enabled: yes

    # ----------------------------
    # ğŸ” AUTENTICACIÃ“N EN DOCKER HUB
    # ----------------------------
    - name: ğŸ” Autenticarse en Docker Hub
      shell: |
        echo "{{ docker_pat }}" | docker login -u {{ docker_user }} --password-stdin
      args:
        executable: /bin/bash

    - name: ğŸ“¥ Descargar imagen personalizada de Redis
      community.docker.docker_image:
        name: "{{ image_name }}"
        source: pull

    # ----------------------------
    # ğŸš€ EJECUCIÃ“N DEL CONTENEDOR REDIS
    # ----------------------------
    - name: ğŸ§° Eliminar contenedor anterior si existe
      community.docker.docker_container:
        name: "{{ container_name }}"
        state: absent
        force_kill: true
        purge_networks: true
      ignore_errors: true

    - name: ğŸš€ Ejecutar contenedor Redis
      community.docker.docker_container:
        name: "{{ container_name }}"
        image: "{{ image_name }}"
        restart_policy: unless-stopped
        network_mode: host   # evita problemas de namespace en LXC
        env:
          REDIS_PASSWORD: "{{ redis_password }}"
        published_ports:
          - "{{ redis_port }}:6379"

    # ----------------------------
    # âœ… VERIFICACIÃ“N FINAL
    # ----------------------------
    - name: ğŸ” Mostrar estado del contenedor Redis
      shell: >
        docker ps --filter "name={{ container_name }}" \
        --format 'table {{ "{{.Names}}\t{{.Status}}\t{{.Ports}}" }}'
      register: redis_status
      changed_when: false

    - debug:
        msg: "{{ redis_status.stdout_lines }}"
