---
- name: Configure NAT Gateway with nftables
  hosts: natgateway
  become: yes
  vars:
    internal_subnets:
      - 10.10.0.0/24
      - 10.20.0.0/24
      - 10.30.0.0/24
    dns_servers:
      - 1.1.1.1
      - 9.9.9.9
      - 208.67.222.222
    static_routes:
      - dest: 10.20.0.0/24
        via: 10.10.0.254
        dev: eth1
      - dest: 10.30.0.0/24
        via: 10.10.0.254
        dev: eth1
    external_interface: eth0
    internal_interface: eth1

  tasks:
    - name: Enable IP forwarding (runtime)
      ansible.posix.sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        state: present
        sysctl_set: yes
        reload: yes

    - name: Ensure IP forwarding is persistent
      ansible.posix.sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        state: present
        sysctl_file: /etc/sysctl.conf
        reload: yes

    - name: Flush existing nftables rules
      ansible.builtin.command:
        cmd: nft flush ruleset
      changed_when: true

    - name: Deploy nftables configuration
      ansible.builtin.copy:
        dest: /etc/nftables.conf
        content: |
          table inet filter {
                  chain input {
                          type filter hook input priority filter; policy drop;
                          iifname "lo" accept
                          ct state established,related accept
                  }
                  chain forward {
                          type filter hook forward priority filter; policy drop;
                          iifname "{{ internal_interface }}" oifname "{{ external_interface }}" ct state established,related,new accept
                          iifname "{{ external_interface }}" oifname "{{ internal_interface }}" ct state established,related accept
                  }
                  chain output {
                          type filter hook output priority filter; policy drop;
                          oifname "lo" accept
                          ct state established,related,new accept
                  }
          }
          table ip nat {
                  chain postrouting {
                          type nat hook postrouting priority srcnat; policy accept;
          {% for subnet in internal_subnets %}
                          ip saddr {{ subnet }} oifname "{{ external_interface }}" masquerade
          {% endfor %}
                  }
          }
        mode: '0644'
        owner: root
        group: root
      notify: reload nftables

    - name: Load nftables rules immediately
      ansible.builtin.command:
        cmd: nft -f /etc/nftables.conf
      changed_when: true

    - name: Check if nftables init script exists
      ansible.builtin.stat:
        path: /etc/init.d/nftables
      register: nftables_init

    - name: Enable nftables service at boot (SysVinit)
      ansible.builtin.command:
        cmd: update-rc.d nftables defaults
      when: nftables_init.stat.exists
      changed_when: true

    - name: Configure DNS servers in resolv.conf
      ansible.builtin.copy:
        dest: /etc/resolv.conf
        content: |
          {% for dns in dns_servers %}
          nameserver {{ dns }}
          {% endfor %}
        mode: '0644'
        owner: root
        group: root

    - name: Add static routes (runtime)
      ansible.builtin.command:
        cmd: "ip route add {{ item.dest }} via {{ item.via }} dev {{ item.dev }}"
      loop: "{{ static_routes }}"
      register: route_result
      failed_when: route_result.rc != 0 and 'File exists' not in route_result.stderr
      changed_when: route_result.rc == 0

    - name: Ensure static routes are persistent in network interfaces
      ansible.builtin.blockinfile:
        path: /etc/network/interfaces
        block: |
          # Static routes for VLAN20 and VLAN30
          {% for route in static_routes %}
          up ip route add {{ route.dest }} via {{ route.via }} dev {{ route.dev }}
          {% endfor %}
        marker: "# {mark} ANSIBLE MANAGED STATIC ROUTES"
        create: yes
        mode: '0644'

    - name: Display completion message
      ansible.builtin.debug:
        msg: "NAT Gateway setup complete on {{ inventory_hostname }}"

  handlers:
    - name: reload nftables
      ansible.builtin.command:
        cmd: nft -f /etc/nftables.conf
      changed_when: true
