---
- name: Configurar servidor PostgreSQL con Docker y NFS
  hosts: database
  become: yes
  vars:
    docker_user: "picantito"
    docker_pat: "{{ lookup('env', 'DOCKER_PAT') }}"
    image_name: "picantito/infraestructure-as-code:postgres-1.0.0"
    container_name: "mypostgres"
    postgres_user: "piero"
    postgres_password: "piero"
    postgres_db: "sgi"
    postgres_data_dir: "/opt/postgres_data"
    nfs_client_ip: "10.10.0.3"

  tasks:
    # ----------------------------
    # INSTALACIÓN DE DOCKER
    # ----------------------------
    - name: Actualizar caché de APT
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Instalar dependencias requeridas
      apt:
        name:
          - ca-certificates
          - curl
        state: present

    - name: Crear directorio para la clave GPG de Docker
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Descargar clave GPG de Docker
      get_url:
        url: https://download.docker.com/linux/debian/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: "0644"

    - name: Obtener arquitectura del sistema
      command: dpkg --print-architecture
      register: system_arch
      changed_when: false

    - name: Obtener codename de Debian
      shell: . /etc/os-release && echo "$VERSION_CODENAME"
      register: debian_codename
      changed_when: false

    - name: Agregar repositorio oficial de Docker
      apt_repository:
        repo: "deb [arch={{ system_arch.stdout }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian {{ debian_codename.stdout }} stable"
        filename: docker
        state: present

    - name: Actualizar caché de APT tras agregar repositorio Docker
      apt:
        update_cache: yes

    - name: Instalar Docker Engine y complementos
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    - name: Asegurar que Docker esté iniciado y habilitado
      systemd:
        name: docker
        state: started
        enabled: yes

    # ----------------------------
    # AUTENTICACIÓN Y DESCARGA DE IMAGEN
    # ----------------------------
    - name: Autenticarse en Docker Hub
      shell: |
        echo "{{ docker_pat }}" | docker login -u {{ docker_user }} --password-stdin
      args:
        executable: /bin/bash

    - name: Descargar imagen personalizada de PostgreSQL
      community.docker.docker_image:
        name: "{{ image_name }}"
        source: pull

    # ----------------------------
    # CONFIGURACIÓN NFS SERVER
    # ----------------------------
    - name: Instalar NFS server
      apt:
        name: nfs-kernel-server
        state: present

    - name: Asegurar permisos correctos en /var/lib/docker
      file:
        path: /var/lib/docker
        mode: "0755"
        recurse: no

    - name: Permitir lectura a contenedores
      file:
        path: /var/lib/docker/containers
        mode: "o+rx"
        recurse: yes

    - name: Configurar exportación NFS
      lineinfile:
        path: /etc/exports
        line: "/var/lib/docker/containers {{ nfs_client_ip }}(rw,sync,no_subtree_check,no_root_squash)"
        create: yes

    - name: Exportar recursos NFS
      command: exportfs -rav

    - name: Reiniciar servicio NFS
      systemd:
        name: nfs-kernel-server
        state: restarted
        enabled: yes

    # ----------------------------
    # CONFIGURAR POSTGRESQL CON DOCKER
    # ----------------------------
    - name: Crear directorio de datos de PostgreSQL
      file:
        path: "{{ postgres_data_dir }}"
        state: directory
        mode: "0755"

    - name: Ejecutar contenedor PostgreSQL
      community.docker.docker_container:
        name: "{{ container_name }}"
        image: "{{ image_name }}"
        restart_policy: unless-stopped
        network_mode: host

        env:
          POSTGRES_USER: "{{ postgres_user }}"
          POSTGRES_PASSWORD: "{{ postgres_password }}"
          POSTGRES_DB: "{{ postgres_db }}"
          POSTGRES_INITDB_ARGS: "--data-checksums"
          PGDATA: "/var/lib/postgresql/data"
        volumes:
          - "{{ postgres_data_dir }}:/var/lib/postgresql/data"

    # ----------------------------
    # VERIFICACIÓN FINAL
    # ----------------------------
    - name: Mostrar estado del contenedor PostgreSQL
      shell: >
        docker ps --filter "name={{ container_name }}" \
        --format 'table {{ "{{.Names}}\t{{.Status}}\t{{.Ports}}" }}'
      register: container_status
      changed_when: false
    - debug:
        msg: "{{ container_status.stdout_lines }}"
