---
- name: Instalar Docker, Grafana y Loki en LXC (modo privilegiado, ejecución manual shell)
  hosts: grafana_loki
  become: yes
  vars:
    grafana_dir: /root/grafana
    grafana_admin_password: admin
    loki_retention_days: 14

  tasks:
    # ----------------------------
    # INSTALACIÓN DE DOCKER
    # ----------------------------
    - name: Actualizar caché de apt
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Instalar paquetes necesarios
      apt:
        name:
          - ca-certificates
          - curl
        state: present

    - name: Crear directorio para clave GPG de Docker
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Descargar clave GPG de Docker
      get_url:
        url: https://download.docker.com/linux/debian/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'

    - name: Obtener arquitectura del sistema
      command: dpkg --print-architecture
      register: system_arch
      changed_when: false

    - name: Obtener codename de Debian
      shell: . /etc/os-release && echo "$VERSION_CODENAME"
      register: debian_codename
      changed_when: false

    - name: Agregar repositorio oficial de Docker
      apt_repository:
        repo: "deb [arch={{ system_arch.stdout }} signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian {{ debian_codename.stdout }} stable"
        filename: docker
        state: present

    - name: Actualizar caché tras añadir Docker repo
      apt:
        update_cache: yes

    - name: Instalar Docker y complementos
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    - name: Asegurar que Docker esté iniciado y habilitado
      systemd:
        name: docker
        state: started
        enabled: yes

    # ----------------------------
    # DESPLIEGUE GRAFANA + LOKI
    # ----------------------------
    - name: Crear directorio principal para Grafana
      file:
        path: "{{ grafana_dir }}"
        state: directory
        mode: '0755'

    - name: Crear archivo de configuración de Loki
      copy:
        dest: "{{ grafana_dir }}/loki-config.yaml"
        content: |
          auth_enabled: false

          server:
            http_listen_port: 3100
            grpc_listen_port: 9095
            log_level: error

          common:
            path_prefix: /loki
            storage:
              filesystem:
                chunks_directory: /loki/chunks
                rules_directory: /loki/rules
            replication_factor: 1
            ring:
              kvstore:
                store: inmemory

          schema_config:
            configs:
              - from: 2020-10-24
                store: tsdb
                object_store: filesystem
                schema: v13
                index:
                  prefix: loki_index_
                  period: 24h

          storage_config:
            tsdb_shipper:
              active_index_directory: /loki/index
              cache_location: /loki/index_cache
              cache_ttl: 24h

          limits_config:
            retention_period: {{ loki_retention_days * 24 }}h
            max_query_lookback: {{ loki_retention_days * 24 }}h

          table_manager:
            retention_deletes_enabled: true
            retention_period: {{ loki_retention_days * 24 }}h
        mode: '0644'

    - name: Crear archivo docker-compose para Grafana y Loki
      copy:
        dest: "{{ grafana_dir }}/docker-compose.yml"
        content: |
          name: grafana
          services:
            grafana:
              image: grafana/grafana:latest
              container_name: grafana
              restart: unless-stopped
              network_mode: host
              environment:
                - GF_LOG_LEVEL=error
                - GF_AUTH_ANONYMOUS_ENABLED=true
                - GF_SECURITY_ALLOW_EMBEDDING=true
                - GF_SECURITY_ADMIN_PASSWORD={{ grafana_admin_password }}
              volumes:
                - grafana_data:/var/lib/grafana
              depends_on:
                - loki

            loki:
              image: grafana/loki:3.3.2
              container_name: loki
              restart: unless-stopped
              network_mode: host
              command: -config.file=/etc/loki/local-config.yaml
              volumes:
                - loki_data:/loki
                - {{ grafana_dir }}/loki-config.yaml:/etc/loki/local-config.yaml:ro
              privileged: true

          volumes:
            grafana_data:
            loki_data:
        mode: '0644'

    # ----------------------------
    # EJECUCIÓN EXACTA COMO MANUAL
    # ----------------------------
    - name: Desplegar contenedores igual que manualmente
      shell: |
        cd {{ grafana_dir }}
        docker compose up -d
      args:
        executable: /bin/bash

    - name: Mostrar estado final
      debug:
        msg: "Grafana y Loki se han desplegado correctamente en {{ grafana_dir }}"
