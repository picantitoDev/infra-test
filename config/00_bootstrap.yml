---
- name: âš™ï¸ Bootstrap connectivity test + DNS speed fix
  hosts: all
  gather_facts: false
  become: true

  tasks:
    # --- ðŸ” VerificaciÃ³n de conexiÃ³n base ---
    - name: ðŸ” Test SSH connection
      raw: echo "âœ… Connected to $(hostname)"

    - name: ðŸ“¡ Show IPs
      raw: ip -4 addr show | grep 'inet '
      register: ip_info
      ignore_errors: true

    - debug:
        var: ip_info.stdout

    # --- ðŸš€ OptimizaciÃ³n de DNS y SSH ---
    - name: âš™ï¸ Disable UseDNS in sshd_config
      raw: |
        if grep -q "^#UseDNS" /etc/ssh/sshd_config; then
          sed -i 's/^#UseDNS.*/UseDNS no/' /etc/ssh/sshd_config
        elif grep -q "^UseDNS" /etc/ssh/sshd_config; then
          sed -i 's/^UseDNS.*/UseDNS no/' /etc/ssh/sshd_config
        else
          echo "UseDNS no" >> /etc/ssh/sshd_config
        fi
        systemctl restart ssh || systemctl restart sshd
      register: ssh_dns_fix
      changed_when: "'UseDNS no' in ssh_dns_fix.stdout or 'UseDNS no' in ssh_dns_fix.stderr"

    - name: âš™ï¸ Disable GSSAPIAuthentication (another DNS delay source)
      raw: |
        if grep -q "^#GSSAPIAuthentication" /etc/ssh/sshd_config; then
          sed -i 's/^#GSSAPIAuthentication.*/GSSAPIAuthentication no/' /etc/ssh/sshd_config
        elif grep -q "^GSSAPIAuthentication" /etc/ssh/sshd_config; then
          sed -i 's/^GSSAPIAuthentication.*/GSSAPIAuthentication no/' /etc/ssh/sshd_config
        else
          echo "GSSAPIAuthentication no" >> /etc/ssh/sshd_config
        fi
        systemctl restart ssh || systemctl restart sshd
      register: ssh_gssapi_fix
      changed_when: "'GSSAPIAuthentication no' in ssh_gssapi_fix.stdout or 'GSSAPIAuthentication no' in ssh_gssapi_fix.stderr"

    # --- ðŸ§± Fallback de DNS local rÃ¡pido ---
    - name: ðŸ§© Add local fallback DNS resolver (Google + Cloudflare)
      raw: |
        if ! grep -q "8.8.8.8" /etc/resolv.conf; then
          echo "nameserver 8.8.8.8" >> /etc/resolv.conf
          echo "nameserver 1.1.1.1" >> /etc/resolv.conf
        fi

    - name: âœ… Summary message
      debug:
        msg: "SSH and DNS optimized successfully on {{ inventory_hostname }}"
