---
- name: ðŸ§© NAT Gateway setup
  become: true
  hosts: nat_gateway
  tasks:

    - name: Ensure IP forwarding enabled
      ansible.posix.sysctl:
        name: net.ipv4.ip_forward
        value: 1
        state: present
        sysctl_set: true
        reload: true

    - name: Install nftables package
      ansible.builtin.apt:
        name: nftables
        state: present
        update_cache: yes

    - name: Deploy nftables configuration
      ansible.builtin.template:
        src: nftables.conf.j2
        dest: /etc/nftables.conf
        owner: root
        group: root
        mode: '0644'
      notify: Reload nftables

    - name: Enable nftables service at boot (systemd)
      ansible.builtin.service:
        name: nftables
        enabled: true
        state: started
      when: ansible_service_mgr == "systemd"

    - name: Enable nftables at boot (SysVinit fallback)
      ansible.builtin.command: update-rc.d nftables defaults
      when: ansible_service_mgr != "systemd"
      changed_when: false
      ignore_errors: true

    - name: Configure persistent DNS
      ansible.builtin.copy:
        dest: /etc/resolv.conf
        content: |
          nameserver 1.1.1.1
          nameserver 9.9.9.9
          nameserver 208.67.222.222
        owner: root
        group: root
        mode: '0644'

    - name: Ensure static routes for VLAN20 and VLAN30 exist
      ansible.builtin.lineinfile:
        path: /etc/network/interfaces
        line: "{{ item }}"
        insertafter: EOF
      loop:
        - "# Static routes for VLAN20 and VLAN30"
        - "up ip route add 10.20.0.0/24 via 10.10.0.254 dev eth1"
        - "up ip route add 10.30.0.0/24 via 10.10.0.254 dev eth1"
      create: yes

    - name: Add runtime static routes (idempotent)
      ansible.builtin.command: "{{ item }}"
      loop:
        - ip route add 10.20.0.0/24 via 10.10.0.254 dev eth1
        - ip route add 10.30.0.0/24 via 10.10.0.254 dev eth1
      register: route_add
      changed_when: "'File exists' not in route_add.stderr"
      failed_when: false
