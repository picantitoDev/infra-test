---
# ==============================================================
# Role: router_10_20
# Description: Configures routing between VLAN10 and VLAN20,
#              sets default route to NAT gateway, and adds VLAN30 route.
# ==============================================================

- name: Enable IP forwarding (runtime)
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    sysctl_set: yes
    reload: yes

- name: Ensure IP forwarding is persistent
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    state: present
    sysctl_file: /etc/sysctl.conf
    reload: yes

# =====================================================
# Disable Reverse Path Filtering (rp_filter)
# =====================================================
- name: Disable rp_filter for all interfaces (runtime)
  ansible.posix.sysctl:
    name: "net.ipv4.conf.{{ item }}.rp_filter"
    value: '0'
    state: present
    sysctl_set: yes
    reload: yes
  loop: "{{ interfaces }}"

- name: Ensure rp_filter settings are persistent
  ansible.posix.sysctl:
    name: "net.ipv4.conf.{{ item }}.rp_filter"
    value: '0'
    state: present
    sysctl_file: /etc/sysctl.conf
    reload: yes
  loop: "{{ interfaces }}"

# =====================================================
# nftables basic firewall/routing configuration
# =====================================================
- name: Flush existing nftables rules
  ansible.builtin.command: nft flush ruleset
  changed_when: true
  failed_when: false

- name: Deploy nftables configuration
  ansible.builtin.template:
    src: nftables.conf.j2
    dest: /etc/nftables.conf
    owner: root
    group: root
    mode: '0644'
  notify: reload nftables

- name: Load nftables rules immediately
  ansible.builtin.command: nft -f /etc/nftables.conf
  changed_when: true

# =====================================================
# Default route and VLAN30 route
# =====================================================
- name: Add default route to NAT gateway (runtime)
  ansible.builtin.command:
    cmd: "ip route add default via {{ nat_gateway_ip }} dev {{ nat_gateway_interface }}"
  register: default_route_result
  failed_when: default_route_result.rc != 0 and 'File exists' not in default_route_result.stderr
  changed_when: default_route_result.rc == 0

- name: Add static route to VLAN30 (runtime)
  ansible.builtin.command:
    cmd: "ip route add {{ vlan30_network }} via {{ vlan30_gateway }} dev {{ vlan30_interface }}"
  register: vlan30_route_result
  failed_when: vlan30_route_result.rc != 0 and 'File exists' not in vlan30_route_result.stderr
  changed_when: vlan30_route_result.rc == 0

- name: Ensure static route to VLAN30 is persistent
  ansible.builtin.blockinfile:
    path: /etc/network/interfaces
    block: |
      # Static route to VLAN30 (via router-20-30)
      up ip route add {{ vlan30_network }} via {{ vlan30_gateway }} dev {{ vlan30_interface }}
    marker: "# {mark} ANSIBLE MANAGED VLAN30 ROUTE"
    create: yes
    mode: '0644'

# =====================================================
# DNS configuration
# =====================================================
- name: Configure DNS servers in resolv.conf
  ansible.builtin.copy:
    dest: /etc/resolv.conf
    content: |
      {% for dns in dns_servers %}
      nameserver {{ dns }}
      {% endfor %}
    owner: root
    group: root
    mode: '0644'

# =====================================================
# Completion message
# =====================================================
- name: Display completion message
  ansible.builtin.debug:
    msg: "Router 10_20 configuration complete on {{ inventory_hostname }}"
