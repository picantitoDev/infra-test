---
# ==============================================================
# Role: database
# Description: Configura y despliega un contenedor PostgreSQL
# ==============================================================

# ----------------------------
# 1️⃣ Autenticación en Docker Hub
# ----------------------------
- name: Autenticarse en Docker Hub
  ansible.builtin.shell: |
    echo "{{ docker_pat }}" | docker login -u {{ docker_user }} --password-stdin
  args:
    executable: /bin/bash
  register: docker_login
  changed_when: "'Login Succeeded' in docker_login.stdout"

# ----------------------------
# 2️⃣ Descargar imagen personalizada
# ----------------------------
- name: Descargar imagen personalizada de PostgreSQL
  community.docker.docker_image:
    name: "{{ image_name }}"
    source: pull

# ----------------------------
# 3️⃣ Preparar directorio de datos
# ----------------------------
- name: Crear directorio de datos de PostgreSQL
  ansible.builtin.file:
    path: "{{ postgres_data_dir }}"
    state: directory
    mode: "0755"

# ----------------------------
# 4️⃣ Desplegar contenedor PostgreSQL
# ----------------------------
- name: Ejecutar contenedor PostgreSQL
  community.docker.docker_container:
    name: "{{ container_name }}"
    image: "{{ image_name }}"
    restart_policy: unless-stopped
    network_mode: host
    env:
      POSTGRES_USER: "{{ postgres_user }}"
      POSTGRES_PASSWORD: "{{ postgres_password }}"
      POSTGRES_DB: "{{ postgres_db }}"
      POSTGRES_INITDB_ARGS: "--data-checksums"
      PGDATA: "/var/lib/postgresql/data"
    volumes:
      - "{{ postgres_data_dir }}:/var/lib/postgresql/data"
  notify: restart postgres container

# ----------------------------
# 5️⃣ Verificación final
# ----------------------------
- name: Mostrar estado del contenedor PostgreSQL
  ansible.builtin.shell: >
    docker ps --filter "name={{ container_name }}" \
    --format 'table {{ "{{.Names}}\t{{.Status}}\t{{.Ports}}" }}'
  register: container_status
  changed_when: false

- ansible.builtin.debug:
    msg: "{{ container_status.stdout_lines }}"
